# Guia de Hardening para VPS Compartilhada

## üéØ Recomenda√ß√£o para Seu Caso

### **MELHOR OP√á√ÉO: Playbook Ansible Otimizado (hardening-vps-shared.yml)**

**Por qu√™?**
- ‚úÖ **Leve:** N√£o sobrecarrega VPS compartilhada
- ‚úÖ **Balanceado:** Seguran√ßa + Performance
- ‚úÖ **Idempotente:** Ansible garante consist√™ncia
- ‚úÖ **Manuten√≠vel:** F√°cil de atualizar e versionar
- ‚úÖ **Revers√≠vel:** Pode desfazer mudan√ßas facilmente

---

## üìä Compara√ß√£o: Script vs Ansible vs CIS Full

| Aspecto | Seu Ansible Atual | Ansible Otimizado | CIS Script Full |
|---------|-------------------|-------------------|-----------------|
| **RECURSOS** |
| Uso de RAM | ~50MB | ~100MB | ~200MB+ |
| Uso de CPU | Baixo | Baixo | M√©dio-Alto |
| I/O Disco | Baixo | Baixo | **ALTO** ‚ö†Ô∏è |
| Tempo instala√ß√£o | 3-5 min | 5-8 min | 15-30 min |
| **SEGURAN√áA** |
| CIS Score | ~60% | ~75% | ~95% |
| SSH Hardening | ‚úÖ B√°sico | ‚úÖ Completo | ‚úÖ Completo |
| Firewall | ‚úÖ B√°sico | ‚úÖ + Docker | ‚úÖ + Docker |
| Auditoria | ‚ö†Ô∏è Lynis only | ‚úÖ Auditd leve | ‚úÖ Auditd pesado |
| AppArmor | ‚ùå N√£o | ‚úÖ Sim | ‚úÖ Sim |
| **COMPATIBILIDADE VPS** |
| VPS compartilhada | ‚úÖ Excelente | ‚úÖ Excelente | ‚ö†Ô∏è **Problem√°tico** |
| Kernel hardening | ‚ùå N√£o (correto!) | ‚ùå N√£o (correto!) | ‚úÖ (pode quebrar!) |
| AIDE | ‚ùå N√£o | ‚ùå N√£o (correto!) | ‚úÖ (I/O pesado!) |
| **MANUTEN√á√ÉO** |
| Facilidade update | ‚úÖ F√°cil | ‚úÖ F√°cil | ‚ö†Ô∏è Dif√≠cil |
| Idempot√™ncia | ‚úÖ Sim | ‚úÖ Sim | ‚ùå N√£o |
| Versionamento | ‚úÖ Git | ‚úÖ Git | ‚ö†Ô∏è Manual |
| Rollback | ‚úÖ F√°cil | ‚úÖ F√°cil | ‚ùå Dif√≠cil |
| **COMPLIANCE** |
| SOC 2 | ‚ö†Ô∏è Parcial | ‚úÖ B√°sico | ‚úÖ Completo |
| Custo/Benef√≠cio | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |

---

## ‚ö†Ô∏è Por Que N√ÉO Usar CIS Full em VPS Compartilhada?

### 1. **AIDE Vai Travar Seu VPS**
```bash
# AIDE faz scan completo do filesystem
# Em VPS compartilhada (I/O limitado):
- Primeiro scan: 30-60 minutos
- Scans di√°rios: 10-30 minutos
- Impacto: VPS fica LENTA para outros clientes
- Resultado: Host pode reclamar ou throttle seu VPS
```

### 2. **Kernel Hardening Pode Quebrar**
```bash
# VPS compartilhada usa kernel do host
# Voc√™ N√ÉO controla o kernel
# Configura√ß√µes como:
kernel.kptr_restrict=2
kernel.dmesg_restrict=1

# Podem causar:
- Aplica√ß√µes quebrarem
- Docker ter problemas
- Logs n√£o funcionarem
```

### 3. **Auditd Excessivo = I/O Hell**
```bash
# CIS Level 2 tem 100+ regras audit
# Cada regra = write em disco
# Em VPS com I/O limitado:
- Logs crescem MUITO
- I/O throttling
- Performance degrada
```

### 4. **AppArmor Enforcing All = Quebra Apps**
```bash
# CIS for√ßa AppArmor enforcing em TUDO
# Muitas apps n√£o t√™m profiles
# Resultado: Apps quebram misteriosamente
```

---

## ‚úÖ Por Que o Playbook Otimizado √© Melhor?

### 1. **Seletivo e Inteligente**
```yaml
# Voc√™ ESCOLHE o que ativar:
enable_aide: false              # ‚úÖ Desliga I/O pesado
enable_kernel_hardening: false  # ‚úÖ Evita problemas com host
enable_auditd_light: true       # ‚úÖ S√≥ eventos cr√≠ticos
```

### 2. **Otimizado para Docker**
```yaml
# UFW + Docker integrado
# N√£o quebra networking de containers
# Logs limitados (5MB max)
```

### 3. **Idempotente**
```bash
# Pode executar v√°rias vezes
ansible-playbook hardening-vps-shared.yml

# Sempre chega no mesmo estado
# Sem duplica√ß√£o de configura√ß√µes
```

### 4. **F√°cil de Customizar**
```yaml
vars:
  vps_ram_mb: 1024        # Ajuste para seu VPS
  ssh_port: 2222          # Mude SSH port facilmente
  f2b_maxretry: 3         # Ajuste fail2ban
  enable_aide: false      # Liga/desliga features
```

---

## üéöÔ∏è Matriz de Decis√£o

### VPS com 512MB RAM:
```yaml
Recomenda√ß√£o: Playbook Otimizado
Configura√ß√£o:
  enable_aide: false
  enable_auditd_light: false  # Desliga audit tamb√©m
  enable_rkhunter: false
  docker_log_size: "3m"
```

### VPS com 1GB RAM:
```yaml
Recomenda√ß√£o: Playbook Otimizado
Configura√ß√£o:
  enable_aide: false
  enable_auditd_light: true   # Audit leve OK
  docker_log_size: "5m"
```

### VPS com 2GB+ RAM:
```yaml
Recomenda√ß√£o: Playbook Otimizado OU CIS Level 1
Configura√ß√£o:
  enable_aide: false          # Ainda evite AIDE
  enable_auditd_light: true
  docker_log_size: "10m"
```

### VPS Dedicada (4GB+):
```yaml
Recomenda√ß√£o: CIS Level 1 ou Level 2
Configura√ß√£o:
  enable_aide: true           # Agora OK
  enable_kernel_hardening: true
  full_audit: true
```

---

## üöÄ Como Usar o Playbook Otimizado

### 1. Prepara√ß√£o

```bash
# No seu computador local
mkdir ~/hardening-vps
cd ~/hardening-vps

# Copiar o playbook
# (arquivo hardening-vps-shared.yml)

# Criar inventory
cat > hosts.ini <<EOF
[vps]
seu-vps.example.com ansible_user=root

[vps:vars]
ansible_python_interpreter=/usr/bin/python3
EOF

# Testar conectividade
ansible -i hosts.ini vps -m ping
```

### 2. Customiza√ß√£o (IMPORTANTE!)

```yaml
# Edite o playbook antes de executar
nano hardening-vps-shared.yml

# Ajuste conforme seu VPS:
vars:
  vps_ram_mb: 1024           # ‚Üê Sua RAM real
  ssh_port: 22               # ‚Üê Mude se quiser
  docker_user: deploy        # ‚Üê Seu usu√°rio preferido
  
  # Features - ajuste conforme necessidade:
  enable_aide: false              # ‚úÖ Mantenha false em VPS pequena
  enable_auditd_light: true       # ‚úÖ true se >1GB RAM
  enable_rkhunter: false          # ‚úÖ Mantenha false
```

### 3. Dry Run (SEMPRE!)

```bash
# Simular sem executar
ansible-playbook -i hosts.ini hardening-vps-shared.yml --check --diff

# Revisar TODAS as mudan√ßas
# Confirmar que est√° OK
```

### 4. Executar

```bash
# Executar de verdade
ansible-playbook -i hosts.ini hardening-vps-shared.yml

# Acompanhar output
# Verificar por erros
```

### 5. Valida√ß√£o

```bash
# SSH no servidor
ssh root@seu-vps

# Verificar relat√≥rio
cat /root/hardening-report.txt

# Testar servi√ßos
systemctl status ssh
systemctl status ufw
systemctl status fail2ban
systemctl status docker

# Verificar firewall
ufw status verbose

# Testar Docker
docker run hello-world
```

---

## üîß Troubleshooting VPS

### Problema: "VPS muito lenta ap√≥s hardening"

**Diagn√≥stico:**
```bash
# 1. Verificar I/O
iostat -x 1 5

# 2. Verificar processos pesados
top -o %MEM

# 3. Verificar auditd
auditctl -l | wc -l
# Se > 50, est√° pesado demais

# 4. Verificar AIDE
ps aux | grep aide
# Se estiver rodando, √© o culpado
```

**Solu√ß√£o:**
```bash
# Desabilitar AIDE
systemctl disable aide
systemctl stop aide

# Reduzir audit rules
auditctl -D  # Remove todas
# Re-executar playbook com enable_auditd_light: false
```

### Problema: "Docker sem conectividade"

**Diagn√≥stico:**
```bash
# Verificar regras UFW
iptables -L DOCKER-USER -n

# Testar container
docker run --rm alpine ping -c 3 google.com
```

**Solu√ß√£o:**
```bash
# Re-aplicar regras UFW+Docker
# Re-executar playbook
```

### Problema: "Lockout SSH"

**Preven√ß√£o:**
```bash
# SEMPRE mantenha uma sess√£o aberta
# SEMPRE teste em nova janela antes de desconectar

# Teste:
ssh -p 22 docker@seu-vps
# Se funcionar, est√° OK
```

**Solu√ß√£o (se locked out):**
```bash
# Use console do provider (VNC/Serial)
# Ou recovery mode

# Reverter SSH config
mv /etc/ssh/sshd_config.backup /etc/ssh/sshd_config
systemctl restart ssh
```

---

## üìä Checklist Pr√©-Hardening VPS

- [ ] **Backup completo** (snapshot do provider)
- [ ] **Chaves SSH testadas** (ssh-copy-id)
- [ ] **Invent√°rio Ansible criado**
- [ ] **Playbook customizado** (vars ajustadas)
- [ ] **Dry-run executado** (--check)
- [ ] **Janela de manuten√ß√£o** (pode dar problema)
- [ ] **Console do provider acess√≠vel** (recovery)
- [ ] **Segunda sess√£o SSH aberta** (seguran√ßa)

---

## üìà Evolu√ß√£o Gradual Recomendada

### Fase 1: B√°sico (Semana 1)
```yaml
enable_docker_hardening: true
enable_auditd_light: false
enable_aide: false
```

### Fase 2: Intermedi√°rio (Semana 2-3)
```yaml
enable_auditd_light: true   # Adicionar audit leve
# Monitorar performance
```

### Fase 3: Avan√ßado (Se performance OK)
```yaml
# Considerar CIS Level 1
# Ou adicionar features extras
```

---

## üí° Dicas Extras para VPS Compartilhada

### 1. Monitoramento Leve
```bash
# Use ferramentas leves
apt install htop iotop

# Evite:
- Prometheus (pesado demais)
- ELK Stack (imposs√≠vel em VPS pequena)
- Grafana (muita RAM)

# Prefira:
- Netdata (leve e eficiente)
- Uptime Kuma (para external monitoring)
```

### 2. Logs Controlados
```bash
# Rota√ß√£o agressiva
logrotate -f /etc/logrotate.conf

# Limitar tamanho de logs
journalctl --vacuum-size=100M
```

### 3. Docker Otimizado
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "5m",    // Pequeno!
    "max-file": "2"      // Poucos arquivos!
  }
}
```

---

## üéØ Conclus√£o

### Para VPS Compartilhada Pequena (‚â§2GB):
**‚úÖ USE: Playbook Ansible Otimizado**

**‚ùå N√ÉO USE: CIS Script Full**

### Exce√ß√µes:
- VPS dedicada (4GB+): CIS Level 1 OK
- Servidor bare metal: CIS Level 2 OK
- Production cr√≠tica: CIS Level 2 + extras

---

## üìö Recursos Adicionais

### Scripts √öteis para VPS

```bash
# 1. Script de diagn√≥stico r√°pido
#!/bin/bash
echo "=== VPS Health Check ==="
echo "RAM: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')"
echo "Disk: $(df -h / | awk 'NR==2 {print $3 "/" $2}')"
echo "Load: $(uptime | awk -F'load average:' '{print $2}')"
echo "Docker: $(docker ps -q | wc -l) containers"
echo "UFW: $(ufw status | grep -c active) active"
```

```bash
# 2. Script de limpeza emergencial
#!/bin/bash
docker system prune -af --volumes
apt-get clean
apt-get autoremove -y
journalctl --vacuum-size=50M
find /var/log -type f -name "*.gz" -delete
```

---

**√öltima atualiza√ß√£o:** Janeiro 2026  
**Vers√£o:** 1.0.0  
**Compatibilidade:** Ubuntu 22.04+, VPS 512MB-2GB
